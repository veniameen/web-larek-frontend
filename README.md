# Описание проекта "Web Lerek"

## Стек технологий

- **TypeScript** — основной язык разработки, обеспечивающий строгую типизацию и предотвращение большинства ошибок на этапе компиляции.
- **HTML** — стандартный язык разметки, используемый для создания структуры веб-страниц.
- **SCSS** — препроцессор CSS, позволяющий писать более компактный и организованный код стилей.
- **Webpack** — инструмент для сборки модулей, который позволяет оптимизировать и упрощать управление зависимостями.

## Структура проекта

Проект имеет следующую структуру, которая помогает поддерживать код организованным и упрощает его масштабирование:

- **src/** — основная папка, содержащая все исходные файлы проекта.
  - **components/** — директория с TypeScript компонентами, отвечающими за пользовательский интерфейс:
    - **PageComponent.ts** — главный компонент страницы, объединяющий все основные элементы интерфейса.
    - **order/** — папка с файлами, связанными с логикой обработки заказов:
      - **errors.ts** — модуль для обработки ошибок, возникающих при работе с заказами.
      - **OrderForm.ts** — логика взаимодействия с формой заказа, включая валидацию данных пользователя.
      - **OrderManager.ts** — управление всеми данными заказов, включая их хранение и обновление.
    - **basket/** — компоненты, отвечающие за функционал корзины:
      - **BasketItem.ts** — компонент для отображения отдельного товара в корзине.
      - **BasketView.ts** — компонент, отвечающий за отображение корзины и взаимодействие с пользователем.
    - **forms/** — директория с компонентами форм:
      - **SuccessView.ts** — отображение сообщения об успешном выполнении действия, например оформления заказа.
      - **FormComponent.ts** — базовый компонент, обеспечивающий переиспользуемость форм.
    - **ProductCard/** — папка для работы с карточками товаров:
      - **ProductCard.ts** — компонент, отображающий информацию о товаре.
      - **ProductData.ts** — файл, содержащий данные и логику, связанную с карточками товаров.
    - **modals/** — компоненты для модальных окон:
      - **ModalView.ts** — базовый компонент модального окна, позволяющий переиспользовать его в различных частях проекта.
      - **ProductPreview.ts** — модальное окно для предпросмотра товара.
    - **base/** — папка с базовыми компонентами и утилитами:
      - **BaseComponent.ts** — базовый компонент, используемый для создания других компонентов.
      - **api.ts** — модуль для взаимодействия с API, включающий методы отправки и получения данных.
      - **events.ts** — брокер событий, реализующий паттерн «Наблюдатель».
  - **types/index.ts** — файл с описанием всех типов, используемых в проекте, что позволяет обеспечить строгую типизацию и упрощает рефакторинг.
  - **utils/** — вспомогательные модули:
    - **utils.ts** — различные утилитарные функции для работы с данными.
    - **constants.ts** — файл, содержащий константы, используемые в проекте, такие как URL-адреса API или настройки приложения.

## Важные файлы

Проект содержит несколько ключевых файлов, которые играют важную роль в его работе:

- **src/index.ts** — точка входа приложения, объединяющая все основные модули и инициализирующая их работу.
- **src/types/index.ts** — файл с типами, обеспечивающий строгую типизацию данных.
- **src/utils/constants.ts** — файл с константами, упрощающий управление фиксированными значениями.
- **src/utils/utils.ts** — вспомогательные функции, которые используются в различных частях проекта.

## Установка и запуск

Для начала работы с проектом выполните следующие шаги:

1. Установите зависимости проекта, используя одну из следующих команд:

```bash
npm install
```

или

```bash
yarn
```

2. Запустите проект в режиме разработки, чтобы проверить его функциональность:

```bash
npm run start
```

или

```bash
yarn start
```

## Сборка проекта

Для подготовки проекта к продакшну выполните сборку с помощью команды:

```bash
npm run build
```

или

```bash
yarn build
```

Сборка проекта создает оптимизированные файлы, готовые к развертыванию на сервере.

## Описание проекта

Проект представляет собой современное веб-приложение типа SPA (Single Page Application), разработанное на TypeScript. Основная цель проекта — предоставить удобный интерфейс для взаимодействия с каталогом товаров и оформления заказов. Ключевые функции включают:

- Просмотр и фильтрация каталога товаров, чтобы пользователи могли легко находить нужные позиции.
- Открытие модального окна с подробной информацией о выбранном товаре.
- Добавление товаров в корзину и их удаление.
- Оформление заказа с возможностью указания адреса доставки, email и номера телефона.

## Основные интерфейсы и типы данных

В данном разделе описаны основные интерфейсы и типы данных, используемые в проекте "Web Lerek". Это позволяет обеспечить строгую типизацию и организованность кода.

### Интерфейсы данных

#### Продукт
Описание данных о товаре, используемых в проекте.
```typescript
export interface Product {
    id: string; // Уникальный идентификатор товара
    description: string; // Описание товара
    image: string; // URL изображения товара
    title: string; // Название товара
    category: string; // Категория товара
    price: number | null; // Цена товара (null, если отсутствует)
}
```

#### Данные формы заказа
Интерфейс для описания данных, которые пользователь вводит при оформлении заказа.
```typescript
export interface OrderFormData {
    payment: string; // Способ оплаты
    address: string; // Адрес доставки
    email: string; // Email клиента
    phone: string; // Номер телефона клиента
}
```

#### Детали заказа
Интерфейс, объединяющий данные формы заказа и информацию о корзине.
```typescript
export interface OrderDetails extends OrderFormData {
    items: string[]; // Список идентификаторов товаров
    total: number;   // Общая стоимость заказа
}
```

#### Результат заказа
Интерфейс, описывающий результат обработки заказа сервером.
```typescript
export interface OrderResult {
    id: string; // Уникальный идентификатор заказа
    total: number; // Итоговая стоимость заказа
}
```

### Типы данных

#### Информация о товаре для модальных окон
Тип для описания данных, отображаемых в модальном окне с информацией о товаре.
```typescript
export type ProductInfo = Pick<Product, 'description' | 'image' | 'title' | 'category' | 'price'>;
```

#### Информация о товаре в корзине
Тип для описания товаров, отображаемых в корзине.
```typescript
export type BasketProductInfo = Pick<Product, 'id' | 'title' | 'price'>;
```

#### Стоимость заказа
Тип для отображения итоговой стоимости заказа.
```typescript
export type OrderCost = Pick<OrderDetails, 'total'>;
```

### Интерфейсы API

#### Shop API
Интерфейс, описывающий взаимодействие с сервером.
```typescript
export interface ShopApiInterface {
    getProducts: () => Promise<Product[]>; // Получение списка товаров
    createOrder: (order: OrderDetails) => Promise<OrderResult>; // Создание заказа
}
```

#### Ответ API на получение товаров
Тип для описания ответа сервера при получении списка товаров.
```typescript
export type ApiGetResponse<T> = {
    total: number; // Общее количество товаров
    items: T[];    // Список товаров
};
```

#### Ответ API на создание заказа
Тип для описания ответа сервера при создании заказа.
```typescript
export type ApiOrderResponse<T> = {
    id: T;        // Идентификатор заказа
    total: number; // Итоговая стоимость заказа
};
```

### Интерфейсы моделей данных

#### Модель данных товаров
Интерфейс для работы с данными о продуктах.
```typescript
export interface ProductsDataInterface {
    products: Product[]; // Список товаров
    previewId: string | null; // ID товара для предпросмотра
    getProductById(productId: string): Product | undefined; // Получение товара по ID
}
```

#### Модель данных заказов
Интерфейс для работы с данными заказов.
```typescript
export interface OrderRepositoryInterface extends OrderFormData {
    order: OrderDetails; // Текущий заказ
    getBasketItems(): BasketProductInfo[]; // Получение товаров в корзине
    removeBasketItem(productId: string): void; // Удаление товара из корзины
    calculateBasketTotal(): number; // Подсчет общей стоимости корзины
    clearBasket(): void; // Очистка корзины
    isProductInBasket(productId: string): boolean; // Проверка, находится ли товар в корзине
    updateOrderField(field: keyof OrderFormData, value: string, fieldsToValidate?: Array<keyof OrderFormData>): void; // Обновление данных заказа
    validateOrderFields(fieldsToValidate?: Array<keyof OrderFormData>): void; // Валидация полей заказа
}
```

## Архитектура проекта

Проект построен на основе парадигмы MVP (Model-View-Presenter), что обеспечивает четкое разделение логики приложения на три слоя, упрощает сопровождение кода и делает его более модульным. Каждый слой имеет свою четко определенную зону ответственности и взаимодействует с другими слоями через строго определенные интерфейсы и события.

1. **Слой представления (View):**
   - Этот слой отвечает за отображение данных на странице и обработку взаимодействий пользователя с интерфейсом через DOM.
   - Он включает такие компоненты, как `PageComponent`, `ModalView`, `ProductPreview`, `BasketView`. Эти компоненты реализуют визуальное представление данных и обеспечивают корректную обработку событий, таких как нажатия кнопок или изменения данных в формах.

2. **Слой данных (Model):**
   - Основная задача слоя данных — управление состоянием приложения и реализация бизнес-логики.
   - Он включает классы `ProductsData` и `OrderManager`, которые обеспечивают доступ к данным товаров и заказов, их валидацию, обработку и сохранение.

3. **Презентер (Presenter):**
   - Этот слой связывает слой представления и слой данных, обрабатывая события, генерируемые пользователем или моделью данных.
   - Презентер реализован в файле `index.ts`. Он инициирует обновления данных, вызывает методы моделей или обновляет отображение на странице через соответствующие компоненты.

### Классы представления

#### Класс `BasketItem`
Класс предназначен для отображения и управления отдельным элементом корзины. Наследует `ProductCard` и обеспечивает обработку удаления товара из корзины.

**Поля:**
- `indexElement` — DOM-элемент для отображения индекса товара в списке.
- `deleteButton` — кнопка удаления товара из корзины.

**Конструктор:**
- Принимает контейнер (`container: HTMLElement`) и экземпляр брокера событий (`IEvents: IEvents`).
- Инициализирует элементы и устанавливает обработчик событий для кнопки удаления.

**Методы:**
- `set index(index: number)` — обновляет индекс товара для отображения пользователю.
  
---

#### Класс `BasketView`
Класс управляет представлением всей корзины, включая отображение списка товаров, общей стоимости и кнопки подтверждения.

**Поля:**
- `listElement` — элемент для отображения списка товаров.
- `totalElement` — элемент для отображения общей стоимости.
- `confirmButton` — кнопка для подтверждения заказа.

**Конструктор:**
- Принимает контейнер (`container: HTMLElement`) и экземпляр брокера событий (`IEvents: IEvents`).
- Устанавливает обработчики событий для кнопки подтверждения.

**Методы:**
- `set items(items: HTMLElement[])` — обновляет список товаров. При отсутствии товаров отображается сообщение "Basket is empty".
- `set total(total: number)` — обновляет отображение общей стоимости корзины.
- `setDisabled(button: HTMLButtonElement | null, isDisabled: boolean)` — переключает состояние кнопки подтверждения.
- `setText(element: HTMLElement | null, text: string)` — обновляет текстовый контент элемента.

---

#### Класс `FormComponent`
Обеспечивает работу с формами, включая валидацию и управление состоянием полей.

**Поля:**
- `submitButton` — кнопка отправки формы.
- `errorContainer` — элемент для отображения ошибок валидации.
- `paymentButtons` — кнопки для выбора способа оплаты.

**Конструктор:**
- Принимает элемент формы (`formElement: HTMLFormElement`) и брокер событий (`IEvents: IEvents`).
- Устанавливает обработчики событий для кнопок оплаты и полей ввода.

**Методы:**
- `handlePaymentToggle(selectedPayment: string)` — переключает активную кнопку выбора оплаты.
- `handleInputChange(field: keyof T, value: string)` — генерирует событие изменения поля формы.
- `set valid(isValid: boolean)` — обновляет состояние кнопки отправки в зависимости от валидности формы.
- `set errors(errorMessages: string[])` — обновляет отображение ошибок.
- `render(state: Partial<T> & FormState)` — обновляет состояние формы на основе переданных данных.

---

#### Класс `SuccessView`
Компонент для отображения сообщения об успешном завершении заказа.

**Поля:**
- `closeButton` — кнопка закрытия окна.
- `totalElement` — элемент для отображения итоговой стоимости.

**Конструктор:**
- Принимает контейнер (`container: HTMLElement`) и объект действий (`actions: SuccessActions`), включая функцию закрытия окна.

**Методы:**
- `set total(total: number)` — обновляет отображение итоговой стоимости заказа.

---

#### Класс `ModalView`
Реализует функциональность модального окна.

**Поля:**
- `closeButton` — кнопка закрытия окна.
- `contentElement` — элемент для отображения содержимого.

**Конструктор:**
- Принимает контейнер (`container: HTMLElement`) и брокер событий (`IEvents: IEvents`).
- Устанавливает обработчики событий для кнопки закрытия и кликов вне содержимого модального окна.

**Методы:**
- `set content(value: HTMLElement | null)` — обновляет содержимое модального окна.
- `open()` — открывает модальное окно.
- `close()` — закрывает модальное окно и очищает содержимое.
- `render(data: ModalData): HTMLElement` — обновляет состояние модального окна и открывает его.

---

#### Класс `ProductPreview`
Предназначен для отображения детальной информации о товаре в модальном окне.

**Поля:**
- `addToBasketButton` — кнопка добавления товара в корзину.
- `descriptionElement` — элемент для отображения описания товара.

**Конструктор:**
- Принимает контейнер (`container: HTMLElement`) и объект действий (`actions: PreviewActions`).

**Методы:**
- `set buttonState(isAdded: boolean)` — обновляет текст кнопки в зависимости от состояния товара в корзине.
- `set price(price: number | null)` — обновляет отображение цены и состояние кнопки добавления.
- `set description(description: string)` — обновляет описание товара.

---

#### Класс `OrderForm`
Управляет формой заказа, расширяя `FormComponent`.

**Поля:**
- `paymentMethod` — выбранный метод оплаты.

**Конструктор:**
- Принимает элемент формы (`formElement: HTMLFormElement`) и брокер событий (`IEvents: IEvents`).

**Методы:**
- `set payment(selectedPayment: string)` — обновляет метод оплаты.
- `set address(address: string)` — устанавливает адрес доставки.
- `set phone(phoneNumber: string)` — устанавливает номер телефона.
- `set email(emailAddress: string)` — устанавливает email клиента.

---

#### Класс `OrderManager`
Обеспечивает логику управления заказом и корзиной.

**Поля:**
- `basketItems` — список товаров в корзине.
- `validationErrors` — ошибки валидации формы.

**Конструктор:**
- Принимает брокер событий (`IEvents: IEvents`).
- Инициализирует состояние заказа.

**Методы:**
- `getBasketItems()` — возвращает список товаров в корзине.
- `removeBasketItem(productId: string)` — удаляет товар из корзины.
- `addBasketItem(item: BasketProductInfo)` — добавляет товар в корзину.
- `calculateBasketTotal()` — подсчитывает общую стоимость корзины.
- `validateOrderFields(fieldsToValidate?: Array<keyof OrderFormData>)` — проверяет поля формы на валидность.
- `clearBasket()` — очищает корзину.

---

#### Класс `PageComponent`
Главный компонент страницы, объединяющий работу с каталогом и корзиной.

**Поля:**
- `basketCounterElement` — элемент для отображения счётчика корзины.
- `catalogElement` — элемент для отображения списка товаров.
- `wrapperElement` — контейнер страницы.
- `basketElement` — кнопка открытия корзины.

**Конструктор:**
- Принимает контейнер (`container: HTMLElement`) и брокер событий (`IEvents: IEvents`).
- Устанавливает обработчик клика для кнопки открытия корзины.

**Методы:**
- `set basketItemCount(count: number)` — обновляет счётчик товаров в корзине.
- `set catalogItems(items: HTMLElement[])` — обновляет список товаров на странице.
- `set isLocked(locked: boolean)` — блокирует или разблокирует страницу.

#### Класс `ProductCard`
Класс предназначен для отображения карточки товара в каталоге. Наследует `BaseComponent`.

**Поля:**
- `categoryElement` — отображает категорию товара.
- `titleElement` — отображает название товара.
- `imageElement` — отображает изображение товара.
- `priceElement` — отображает цену товара.
- `productId` — уникальный идентификатор товара.

**Конструктор:**
- Принимает контейнер (`container: HTMLElement`) и экземпляр брокера событий (`events?: IEvents`).
- Инициализирует элементы карточки и обрабатывает событие клика на карточку.

**Методы:**
- `set price(price: number | null)` — устанавливает цену товара.
- `set image(imageUrl: string)` — задаёт URL изображения товара.
- `set title(productTitle: string)` — устанавливает название товара.
- `set category(categoryName: string)` — задаёт категорию товара.
- `set id(productId: string)` — сохраняет идентификатор товара.
- `get id()` — возвращает идентификатор товара.
- `removeClickListener()` — удаляет обработчик клика на карточку.

---

#### Класс `ProductData`
Класс отвечает за хранение и управление данными товаров. Реализует интерфейс `ProductsDataInterface`.

**Поля:**
- `productList` — массив объектов `Product`.
- `activePreviewId` — ID товара для предпросмотра.
- `IEvents` — экземпляр брокера событий.

**Конструктор:**
- Принимает экземпляр брокера событий (`IEvents`).
- Инициализирует состояние данных.

**Методы:**
- `set products(products: Product[])` — обновляет список товаров и инициирует событие `products:changed`.
- `get products()` — возвращает текущий список товаров.
- `getProductById(productId: string)` — ищет товар по ID.
- `set previewId(productId: string | null)` — устанавливает ID товара для предпросмотра и инициирует событие `previewId:changed`.
- `get previewId()` — возвращает ID текущего товара для предпросмотра.

---

#### Класс `ApiService`
Класс обеспечивает взаимодействие с API.

**Поля:**
- `baseUrl` — базовый URL сервера.
- `options` — настройки запросов.

**Конструктор:**
- Принимает `baseUrl` (строка) и `options` (опционально `RequestInit`).
- Устанавливает базовые заголовки запросов.

**Методы:**
- `handleResponse<T>(response: Response)` — обрабатывает ответ сервера, возвращает JSON или выбрасывает ошибку.
- `get<T>(uri: string)` — выполняет GET-запрос по указанному URI.
- `post<T>(uri: string, data: object, method: ApiPostMethod)` — выполняет POST, PATCH или DELETE запрос с указанными данными.

---

#### Класс `BaseComponent`
Абстрактный класс, предоставляющий базовый функционал для работы с DOM.

**Поля:**
- `container` — корневой DOM-элемент компонента.

**Конструктор:**
- Принимает `container: HTMLElement`.

**Методы:**
- `toggleClass(element: HTMLElement, className: string, force?: boolean)` — переключает класс у элемента.
- `setText(element: HTMLElement, value: unknown)` — устанавливает текстовое содержимое элемента.
- `setDisabled(element: HTMLElement, state: boolean)` — блокирует или разблокирует элемент.
- `setHidden(element: HTMLElement)` — скрывает элемент.
- `setVisible(element: HTMLElement)` — отображает элемент.
- `setImage(element: HTMLImageElement, src: string, alt?: string)` — устанавливает изображение и альтернативный текст.
- `render(data?: Partial<T>)` — обновляет состояние компонента и возвращает корневой DOM-элемент.

---

#### Класс `EventEmitter`
Реализует брокер событий для управления подписками и их обработкой.

**Поля:**
- `_events` — карта событий и их обработчиков.

**Конструктор:**
- Инициализирует карту `_events`.

**Методы:**
- `on<T>(event: EventName, callback: (data: T) => void)` — подписывает обработчик на событие.
- `off(event: EventName, callback: Subscriber)` — снимает обработчик с события.
- `emit<T>(event: string, data?: T)` — инициирует событие.
- `onAll(callback: (event: EmitterEvent) => void)` — подписывает обработчик на все события.
- `offAll()` — снимает все обработчики событий.
- `trigger<T>(event: string, context?: Partial<T>)` — возвращает коллбэк для генерации событий.


### Взаимодействие компонентов

Взаимодействие между слоями построено на основе событийной модели, что делает архитектуру проекта гибкой и масштабируемой. Основным инструментом для обработки событий является брокер событий `EventEmitter`. Он позволяет компонентам и моделям данных генерировать события и подписываться на них.

Пример взаимодействия:
1. Пользователь нажимает на карточку товара на главной странице.
2. Компонент `ProductCard` генерирует событие `product:selected`, передавая в него ID выбранного товара.
3. Презентер в `index.ts` обрабатывает это событие, вызывает метод `previewId` класса `ProductsData`, обновляя данные о текущем товаре.
4. Генерируется новое событие `previewId:changed`, которое инициирует рендеринг модального окна с подробной информацией о товаре.
5. Компонент `ModalView` обновляет своё содержимое, используя данные, предоставленные `ProductsData`, и отображает модальное окно.

Такой подход обеспечивает высокую степень разделения ответственности, что облегчает добавление новых функций, модификацию существующих и тестирование проекта. Каждый слой может быть легко адаптирован под новые требования, сохраняя при этом низкую связанность с другими слоями.

## Список событий

В проекте используется событийная модель для взаимодействия между различными компонентами и слоями. Ниже представлен список событий, которые генерируются и обрабатываются в рамках системы. Эти события делятся на два типа: события изменения данных и события взаимодействия пользователя с интерфейсом.

### События изменения данных
Эти события генерируются моделями данных, когда происходят изменения состояния, такие как обновление списка товаров или изменение содержимого корзины.

- **`products:changed`** — генерируется, когда обновляется список товаров. Это может происходить при загрузке данных с сервера или при фильтрации каталога.
- **`previewId:changed`** — сигнализирует об изменении ID текущего товара, выбранного для предпросмотра. Это событие используется для обновления модального окна с информацией о товаре.
- **`basket:changed`** — инициируется при добавлении или удалении товара из корзины, а также при её очистке.
- **`formErrors:changed`** — уведомляет об изменениях в объекте ошибок валидации формы заказа. Это помогает динамически отображать ошибки в интерфейсе.

### События взаимодействия пользователя
Эти события генерируются компонентами представления в ответ на действия пользователя, такие как нажатия кнопок или ввод данных в форме.

- **`product:selected`** — инициируется при выборе товара на странице. Используется для открытия модального окна с подробной информацией о товаре.
- **`basket:open`** — сигнализирует об открытии модального окна корзины.
- **`product:delete`** — генерируется при удалении товара из корзины, как через кнопку "Удалить из корзины", так и через модальное окно предпросмотра.
- **`order:open`** — инициируется при открытии модального окна с формой оформления заказа.
- **`details:submit`** — уведомляет о попытке отправки формы с деталями заказа.
- **`order:submit`** — сигнализирует об отправке данных заказа на сервер.
- **`details.payment:changed`** — инициируется при изменении выбранного метода оплаты.
- **`details.address:changed`** — сигнализирует об изменении адреса доставки.
- **`order.email:changed`** — уведомляет об изменении состояния поля ввода email.
- **`order.phone:changed`** — инициируется при изменении состояния поля ввода номера телефона.
- **`modal:open`** — сигнализирует об открытии любого модального окна.
- **`modal:close`** — уведомляет о закрытии модального окна.

### Взаимодействие событий

Пример использования событийной модели:
1. Пользователь добавляет товар в корзину. Компонент `ProductPreview` генерирует событие `basket:changed`, передавая информацию о добавленном товаре.
2. Это событие обрабатывается `OrderManager`, который обновляет содержимое корзины и пересчитывает её общую стоимость.
3. Генерируется новое событие `basket:changed`, которое обрабатывается компонентом `BasketView`, обновляя отображение корзины на странице.

Событийная модель позволяет легко добавлять новые сценарии и точки взаимодействия, обеспечивая низкую связанность между компонентами и слоями приложения.